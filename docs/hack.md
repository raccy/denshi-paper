# 3分ハッキング

3分間じゃなくて3日間のような気がする。

## アプリ自体のハッキング

アプリはElectron製です。一部バイナリの外部ライブラリありますが、本体のロジックが書かれた部分はJavaScriptファイルをtarのように書庫化したasarファイル[^1]footnote:です。`asar` コマンドを用いて展開すれば、ソースコードは見えてしまいます。

[^1]: [asar](https://github.com/electron/asar)の説明を参照。

では、ライセンス上はどうなのんかということで、富士通製アプリケーションのライセンスを見てみましょう。

http://www.fmworld.net/digital-paper/support/download/dppapp/

> _使用許諾契約書（ライセンス条項）- 5. 改造等_
>
> お客様は、本ソフトウェアを改造したり、あるいは、逆コンパイル、逆アセンブルを
> ともなうリバースエンジニアリングを行うことはできません。

書庫を展開することを逆コンパイルや逆アセンブルとは言いません。また、この文言では、「逆コンパイル、逆アセンブルを**ともなわない**リバースエンジニアリング」は禁止されていません。

では、ソニー製アプリケーションのライセンスも見てみます。

https://www.sony.jp/digital-paper/apl/dpa.html

> _ソフトウェア使用許諾契約書 - 第３条（権利の制限）5._
>
> お客様は、許諾ソフトウェアに関しリバースエンジニアリング、逆アセンブル、逆コンパイル等のソースコード解析作業を行ってはならないものとします。

「**等**」の文言があるため、あらゆるソースコード解析作業は禁止事項にあたる可能性があります。続けて、次のようにも書いてあります。



> _ソフトウェア使用許諾契約書 - 第３条（権利の制限）6._
>
> 許諾ソフトウェアの使用に伴い、許諾ソフトウェアが自動的に許諾ソフトウェアで用いるためのデータファイルを作成する場合があります。この場合、当該データファイルは許諾ソフトウェアと看做されるものとします。

この条項が法律的に有効であるかは不明です。footnote:[通常、ライセンス条項が有効になる根拠はそのソフトウェア自身が著作物であることによります。ソフトウェアが作成したデータがソフトウェアの著作者の著作物になるのかは疑わしいため、それらについても保護できるかは不明瞭です。「当該ソフトウェアと見做す」こと自体ができない可能性があり、「許諾ソフトウェアと同一範囲の使用に限る」等の表現にしなければ、有効ではない可能性があります。]

なお、このドキュメントは通信データの解析結果を元にAPIの動作を調査しており、ソースコード解析等はしていません。

## 通信データのハッキング

アプリと電子ペーパーの通信のやり取りは三種類です。

1. USB
2. Blootooth
3. Wi-Fi
4. NFC

USBは[USBPcap](https://desowin.org/usbpcap/)を用いることで通信内容を見ることができます。キャプチャしたデータはWiresharkで閲覧可能です。Blootoothは[BlueZ](http://www.bluez.org/)というツールがありますが、Linuxのみのようです。Windows上で行う方法は不明のため、今回は対象としていません。NFCは改造以外でのハッキングは不可能と思われます。なお、USB、BlootoothともにWindowsデバイス上からは電話デバイス(📞マーク)として認識されます。

Wi-Fiはネットワーク通信ですので、Wireshark + npcapの組合せでキャプチャすることが王道でしょう。しかし、電子ペーパーとの通信にはHTTPSが含まれています。HTTPS通信を盗み見るには復号化するための鍵が必要ですが、ブラウザ等とは異なるため、アプリからデバッグ情報として取得する方法は見つけられませんでした。

そのため、今回は、リバースプロキシもどきを行う通信データ閲覧用ツールを作ることで対応しました。

## 通信データ閲覧ツール

通信データ閲覧ツールが行うことは三つです。

1. mDNSで `_dp_fujitsu._tcp` サービスを通知。
2. 8080でHTTPサーバーを起動し、リクエストを電子ペーパーへ送り、そのレスポンスを返す。
3. 8443でHTTPSサーバーを起動し、リクエストを電子ペーパーへ送り、そのレスポンスを返す。

mDNS、HTTP通信、HTTPS通信はWiresharkでのパケットキャプチャの結果判明した動作です。ツールを動作させるには、あらかじめ次の設定をしておく必要があります。

* 自己署名証明書を作成し、信頼済み証明書としてインストールしておく。
* Windows上のアプリケーションが電子ペーパーと通信しないようにファイアウォールに受信のブロックルールを追加する。(IPv6もブロックすることを忘れないように)

このようにすることで、アプリはツールで作成された偽の電子ペーパーと通信を行います。ツール自体がHTTPSサーバーになるため、復号化された通信データを取得することが可能になります。
